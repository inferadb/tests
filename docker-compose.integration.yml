# Docker Compose for K8s Integration Tests
# This runs only the test runner against a local kind cluster
# The server and management API are deployed in Kubernetes

networks:
  host:
    name: host
    external: true

services:
  # Test runner - Executes integration tests against K8s cluster
  test-runner:
    build:
      context: ..
      dockerfile: tests/Dockerfile.integration
    container_name: inferadb-k8s-test-runner
    network_mode: host
    environment:
      - RUST_LOG=debug
      # Connect to K8s NodePort endpoints (mapped to host ports via kind extraPortMappings)
      - MANAGEMENT_API_URL=http://localhost:3000
      - SERVER_URL=http://localhost:8080
      - SERVER_INTERNAL_URL=http://localhost:9090
      - SERVER_GRPC_URL=http://localhost:50051
      - TEST_TIMEOUT=300
    volumes:
      - ../tests:/workspace/tests
      - ../target:/workspace/target
    command: cargo test --test integration --manifest-path tests/Cargo.toml -- --test-threads=1 --nocapture
